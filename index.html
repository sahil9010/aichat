<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Portfolio Chatbot</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }

        /* ---------------------------------- */
        /* Chat Widget Styling */
        /* ---------------------------------- */

        /* Fixed button position */
        #chat-trigger {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        /* Chat Modal position */
        #chat-modal {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 90vw; /* Responsive width */
            max-width: 400px; /* Max width for desktop */
            height: 70vh;
            max-height: 550px;
            z-index: 999;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform-origin: bottom right;
        }

        #chat-modal.open {
            transform: scale(1);
            opacity: 1;
        }

        /* Message container scroll styles */
        #chat-history {
            height: calc(100% - 100px); /* Adjust based on header/footer size */
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Custom scrollbar for aesthetics */
        #chat-history::-webkit-scrollbar {
            width: 6px;
        }
        #chat-history::-webkit-scrollbar-thumb {
            background-color: #9ca3af; /* gray-400 */
            border-radius: 3px;
        }
        #chat-history::-webkit-scrollbar-track {
            background-color: #f3f4f6; /* gray-100 */
        }
        
    </style>
</head>
<body>

    <!-- ---------------------------------- -->
    <!-- 1. Chat Trigger Button (Fixed) -->
    <!-- ---------------------------------- -->
    <button id="chat-trigger" 
            class="bg-indigo-600 text-white p-4 rounded-full shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300">
        <!-- Chat Icon (Inline SVG for simplicity) -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 0 2 2z"></path>
        </svg>
    </button>

    <!-- ---------------------------------- -->
    <!-- 2. Chat Modal (Hidden by default) -->
    <!-- ---------------------------------- -->
    <div id="chat-modal" class="bg-white rounded-xl flex flex-col overflow-hidden">
        
        <!-- Header -->
        <header class="bg-indigo-600 text-white p-4 flex justify-between items-center shadow-md">
            <h2 class="text-lg font-semibold flex items-center">
                <span class="mr-2 text-xl">ðŸ¤–</span> PortfoBot Assistant
            </h2>
            <button id="close-chat" class="p-1 rounded-full hover:bg-indigo-700 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </header>

        <!-- Chat History Container -->
        <div id="chat-history" class="flex-grow">
            <!-- Messages will be injected here -->
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden absolute top-1/2 left-0 right-0 p-4 text-center bg-white/70 backdrop-blur-sm">
            <div class="flex items-center justify-center text-indigo-600">
                <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Typing...
            </div>
        </div>

        <!-- Input Form -->
        <form id="chat-form" class="p-3 border-t border-gray-200">
            <div class="flex gap-2">
                <input type="text" id="user-input" placeholder="Ask about my skills or projects..."
                       class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
                <button type="submit" id="send-btn"
                        class="bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition duration-150 disabled:opacity-50">
                    Send
                </button>
            </div>
        </form>
    </div>

    <script>
        const chatModal = document.getElementById('chat-modal');
        const chatTrigger = document.getElementById('chat-trigger');
        const closeChat = document.getElementById('close-chat');
        const chatHistory = document.getElementById('chat-history');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const loadingIndicator = document.getElementById('loading-indicator');

        // Note: The API Key is intentionally left empty. The host environment (like Canvas)
        // must inject it for the API call to work. If running locally, this will fail 
        // with a clear error message.
        const apiKey = "AIzaSy...YOUR_ACTUAL_KEY_HERE...xyz123"; 

        // Initial messages
        let chatMessages = [
            { sender: 'ai', text: "Hello! I'm PortfoBot, the AI assistant for this portfolio. Ask me anything about the developer's skills, experience, or projects!" }
        ];

        // --- UI Control Functions ---
        
        chatTrigger.addEventListener('click', () => {
            chatModal.classList.toggle('open');
            if (chatModal.classList.contains('open')) {
                userInput.focus();
                scrollToBottom();
            }
        });

        closeChat.addEventListener('click', () => {
            chatModal.classList.remove('open');
        });

        const scrollToBottom = () => {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        };

        const renderMessage = (message) => {
            const isAI = message.sender === 'ai';
            const alignment = isAI ? 'justify-start' : 'justify-end';
            const bgColor = isAI ? 'bg-gray-100 text-gray-800' : 'bg-indigo-500 text-white';
            const name = isAI ? 'PortfoBot' : 'You';
            const borderRadius = isAI ? 'rounded-br-xl rounded-tr-xl rounded-bl-xl' : 'rounded-tl-xl rounded-tr-xl rounded-bl-xl';

            const messageEl = document.createElement('div');
            messageEl.className = `flex ${alignment}`;
            messageEl.innerHTML = `
                <div class="max-w-xs sm:max-w-sm p-3 shadow-md ${bgColor} ${borderRadius}">
                    <p class="text-xs font-semibold mb-1 ${isAI ? 'text-indigo-600' : 'text-indigo-200'}">${name}</p>
                    <p class="text-sm whitespace-pre-wrap">${message.text}</p>
                </div>
            `;
            chatHistory.appendChild(messageEl);
        };

        const renderHistory = () => {
            chatHistory.innerHTML = '';
            chatMessages.forEach(renderMessage);
            scrollToBottom();
        };

        // Render initial welcome message on load
        document.addEventListener('DOMContentLoaded', renderHistory);

        // --- Gemini API Call ---

        // The system instruction defines the AI's role, personality, and knowledge base.
        const SYSTEM_INSTRUCTION = "You are the friendly, professional AI Portfolio Assistant, named 'PortfoBot', for the owner of this website. Your primary role is to answer questions about the owner's skills (like JavaScript, React, Design, Firebase), projects (e.g., a real-time chat app, an e-commerce platform), and professional background. Maintain a helpful, enthusiastic, and concise tone. When asked personal questions, politely redirect them to professional topics. Never make up contact details. Start with a warm greeting relevant to the user's last question.";

        const callGeminiAPI = async (prompt) => {
            // Check for missing API key (essential for local testing/deployment)
            if (!apiKey) {
                console.error("Gemini API Error: apiKey is missing.");
                return "The API key is missing. This feature works only when the app is running in the designated environment. You can check the code for the integration logic!";
            }
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                // We do NOT use search grounding here as the AI should simulate portfolio knowledge
                systemInstruction: {
                    parts: [{ text: SYSTEM_INSTRUCTION }]
                },
            };

            const maxRetries = 5;
            let retryCount = 0;

            const executeFetch = async () => {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retryCount < maxRetries) {
                        const delay = Math.pow(2, retryCount) * 1000 + Math.random() * 1000;
                        retryCount++;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return executeFetch();
                    }
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                return response.json();
            };

            try {
                const result = await executeFetch();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                return text || "I received an empty response. Could you try rephrasing your question?";
            } catch (error) {
                console.error("Gemini API Error:", error);
                return `An error occurred while connecting to the AI. Details: ${error.message}.`;
            }
        };

        // --- Form Submission Handler ---

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const prompt = userInput.value.trim();
            if (!prompt) return;

            // 1. Add user message
            chatMessages.push({ sender: 'user', text: prompt });
            userInput.value = '';
            renderHistory();

            // 2. Disable input and show loading
            sendBtn.disabled = true;
            userInput.disabled = true;
            loadingIndicator.classList.remove('hidden');

            try {
                let aiResponseText;

                if (apiKey === "") {
                    // Local fallback error message
                    aiResponseText = "The AI feature requires the API key to be injected by the hosting environment. Since the key is missing, I cannot process your request. Please view this application in a running environment (like Canvas) for full functionality!";
                } else {
                    // Call the real API
                    aiResponseText = await callGeminiAPI(prompt);
                }

                // 3. Add AI message
                chatMessages.push({ sender: 'ai', text: aiResponseText });
                renderHistory();

            } catch (error) {
                console.error("Chat error:", error);
                chatMessages.push({ sender: 'ai', text: "Oops! I hit an unexpected error while processing your request." });
                renderHistory();
            } finally {
                // 4. Re-enable input and hide loading
                sendBtn.disabled = false;
                userInput.disabled = false;
                loadingIndicator.classList.add('hidden');
                userInput.focus();
            }
        });

    </script>
</body>
</html>
